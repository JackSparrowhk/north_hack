# 应急响应

## 介绍

### 概念

网络安全
		是指通过采取必要措施， 防范对网络的攻击、侵入、干扰、破坏和非法使用以及意外事故，使 网络处于稳定可靠运行的状态，以及保障网络数据的完整性、保密性、可用性的能力。

网络安全事件
		是指由于人为原因、软硬件缺陷或故障、自然灾害等，对网络和信息系统或者其中的数据造成危害，对社会造成负面影响的事件，可分为有害程序事件、网络攻击事件、信息破坏事件、信息内容安全事件、设备设施故障、灾害性事件和其他事件。

应急响应
		是指组织为了应对害发/重大信息安全事件的发生所做的准备，以及在事件发生后所采取的措施。

### 特点

|          |                                                              |
| -------- | ------------------------------------------------------------ |
| 不确定性 | 时间不确定、目标系统不确定、损失不确定、恢复时间不确定。     |
| 压力大   | 系统或者网络对于生产、办公的影响大，一旦短时间内不能恢复将产生较大甚至巨大的损失 |
| 时间短   | 需要迅速找到事件原因并使其恢复使用，在短时间内需要报告、梳理问题、解决问题和问题回顾。 |
| 资源有限 | 短时间内难以调配全面的资源处置问题。                         |

### 技术视角

**由被动的响应防守转向主动防御**

​		技术的不断更新，促使各单位在应急响应的状态上发生了转变，不再由过去的被动的等待问题出现再去处理，逐步的演变为主动监测，主动分析,提前发现问题，把问题解决于没有发生以前

**由传统的事件驱动转向常态化、持续化**

​		早期的应急响应以事件发生再去处理为主，发生一件处理一件，现在，更多的甲方把应急响应做为一项日常的工作来开展，在日常工作中做业务连续计划、灾难恢复计划，定期进行应急演练，把应急响应做为常态化、持续化的一项工作来抓。

**由资源消耗转向资源储备**

​		应急响应是一项消耗资源的工作，尤其是人力成本和财力成本，现更多的单位通过常态化的应急响应，储备一级、二级甚至三级的应急体系，包括不同方向的人员储备、财力支持、政策支持等，加强应急响应的资源储备，防止问题发生时，资源无法协调的问题发生。

### **管理角度**

应急响应的时间窗口越来越小
		新一代威胁不仅传播速度更快，其所利用的攻击面也越来越宽广，可以覆盖移动、桌面、网络、Web和各种应用、社交网络等

应急响应所需的威胁知识、专业技能、技术手段等却不断增加
		专业化、系统化、自动化等越来越关键，大规模的安全情报系统和专家社会网络系统相互融合,“云地人机”协同作战将会成为网络安全应急响应的新常态。

### 信息安全风险

安全管理制度的制定或执行上存在缺陷
		如未定期进行应急演练或未定期更新完善应急预案等情况造成的安全风险

系统在设计和建设时遗留下来的安全风险

​		如带宽设计不足、系统存在漏洞等方面带来的安全风险
系统硬件设施存在安全风险
​		如部件老化或自带有可被攻击利用的功能模块等各种形式的硬件设施安全风险

### 安全攻击事件

安全攻击事件指通过网络或其他技术手段，利用信息系统的缺陷或使用暴力攻击对信息系统实施攻击，或人为使用非技术手段对信息系统进行破坏，而造成信息系统异常的事件。

- 有害事件

- 包括计算机病毒事件、蠕虫事件、特洛伊木马事件、僵尸网络事件、混合程序攻击事件、网页内嵌恶意代码事件和其他有害程序事件

- 网络攻击事件

  包括拒绝服务攻击事件、后门攻击事件、漏洞攻击事件、网络扫描窃听事件、网络钓鱼事件千扰事件和其他网络攻击事件

- 信息破坏事件

  包括信息算改事件、信息假冒事件、信息泄露事件、信息窃取事件、信息丢失事件和其他信息破坏事件

### 设备设施故障

​		设备设施故障是指由于信息系统自身故障或外围保障设施故障而导致的信息安全事件，以及人为的使用非技术手段无意的造成信息系统设备设施损坏的信息安全事件
**软硬件自身故障**
​		指因信息系统中硬件设备的自然故障、软硬件设计缺陷或者软硬件运行环境发生变化等而导致的
信息安全事件。

**外围保障设施故障**

​		指由于保障信息系统正常运行所必须的外部设施自身出现故障而导致的信息安全事件，例如电力故障、外围网络故障等
**其它设备设施故障**
​		指不能被包含在以上2个子类之中的设备设施故障而导致的信息安全事件

### 应急事件I级(特别重大事件)

根据信息安全事件的分级考虑要素，将信息安全事件划分为四个级别符合下列情形之一的，为 I 级网络与信息安全事件。

- 等级保护4级系统中断2小时以上或出现严重信息泄露
- 等级保护4级信息系统中的数据丢失或被窃取、篡改、假冒，对国家安全和社会稳定构成特别严重威胁，或导致特别严重的经济损失。
- 其他对国家安全、社会秩序、经济建设和公众利益成特别严重威胁、造成特别严重影响的网络与信息安全事件

### 应急事件II级(重大事件)

符合下列情形之一且未达到 I级的，为II级网络与信息安全事件

- 等级保护4级系统中断0.5小时，等级保护3级系统中断2小时以上或出现严重信息泄露。
- 等级保护3级信息系统中的数据丢失或被窃取、篡改、假冒，对国家安全和社会稳定构成严重威胁，或导致严重经济损失。
- 其他对国家安全、社会秩序、经济建设和公众利益构成严重威胁、造成严重影响的网络与信息安全事件

### 应急事件III级(较大事件)

符合下列情形之一且未达到II级的，为III级网络与信息安全事件

- 等级保护2级信息系统中断运行或信息发生严重泄露，造成较严重影响的。
- 等级保护2级信息系统中的数据丢失或被窃取、篡改、假冒，对国家安全和社会稳定构成威胁，或导致较严重经济损失
- 其他对国家安全、社会秩序、经济建设和公众利益构成较严重威胁、造成较严重影响的网络与信息安全事件

### 应急事件IV级

除此之外都算一般事件

## 流程

### NIST.SP.800

NIST SP800-61是美国国家标准与技术研究院 (NationalInstitute of Standards and Technology，简称NIST)发布的一份重要文档，全名为"Computer SecurityIncident Handling Guide”(计算机安全事件处理指南)。

该指南旨在指导组织和个人应对计算机安全事件，以减少对信息系统的影响并恢复正常的运行状态。
SP800-61提供了关于安全事件的定义、识别、报告和响应方面的详细指导，并提出了用于建立和维护安全事件响应能力的基本原则和步骤。

它介绍了各种类型的安全事件，包括计算机网络入侵.恶意软件感染、数据泄露等，并提供了相应的处理流程和建议。

### 准备阶段

**在准备阶段要完成几件重要事项**

- 风险评估。

​		标识信息系统的资产价值，识别信息系统面临的自然的和人为的威胁，识别信息系统的脆弱性，分析各种威胁发生的可能性

- 业务影响分析(Businessmpact Analysis)。

​		在风险评估的基础上，分析各种信息安全事件发生时对业务功能可能产生的影响，进而确定应急响应的恢复目标。

- 系统恢复能力等级。

​		为基本支持、备用场地支持、电子传输和部分设备支持、电子传输及完整设备支持、实时数据传输及完整设备支持及数据零丢失和远程集群支持等6个等级

- 恢复目标确定

  恢复时间目标(RTO) 和恢复点目标(RPO)

**建立应急响应组织**

人员、职责、服务范围

**制定应急响应制度**

目标、原则、范围、各项管理制度

**风险评估与改进**

**事件分级标准**

**应急预案**

**应急演练方案**

### 检测阶段

- 检测分析阶段，强调持续
  - 检测目标
    - 业务系统、支撑系统、网络设备、安全设备、物理环境等
  - 检测来源
    - 安全系统日志、文件完整性、第三方监测服务、日志、蜜罐等
  - 前兆和迹象
    - 前兆，事件发生前的现象，如ddos试攻击、扫描
    - 迹象，事件已经发生的现象，如进程中断、日志暴增

### 分析阶段

- 确定事件原因
- 确定事件性质，分级分类
- 事件分析建议
  - 网络和系统特征，如流量大小，开放端口数量
  - 熟悉正常的行为，来判断异常
  - 集中收集日志
  - 开展关联性分析
  - 保证时间同步
  - 建立知识库

安全事件响应优先级，可以参照业务影响分析(BIA)的结果，也可以建立一个表格来进行判断

![image-20230914145942970](C:\Users\16159\AppData\Roaming\Typora\typora-user-images\image-20230914145942970.png)

- 启动应急响应
  - 启动原则--快速、有序
  - 启动依据--受损程度
  - 启动方法--由应急响应领导小组发布启动
- 记录所有操作，直到应急响应结束

- 确定事态严重程度与损害评估后，应通知应急响应领导小组，事先制 定通知路径
- 信息安全事件发生后，应按照相关规定和要求，及时将情况上报相关主管或监管单位/部门

### 限制阶段

- 限制策略，在安全事件检测并分析后，在造成更大破坏前进行限制》
- 针对不同事件会有不同限制策略》 
- 限制过程中应考虑
  - 资源的潜在破坏和失窃
  - 对证据收集影响，如重启后会丢失当前内存
  - 服务的可用性
  - 执行策略所需资源和时间
  - 限制策略的有效性



### 消除、恢复阶段

- 消除工作
  - 清除恶意代码、禁用违规账号
- 有时，消除工作可以跳过，直接进行恢复 
- 恢复工作，直接将系统从备份中恢复到正常状态，并加固
- 恢复工作之后，需要加强监视
- 恢复工作优先级可以参照业务影响分析
- 恢复后，通告应急结束

### 跟踪总结

- 事件原因、发生时间
- 事件处置流程如何?是否合规?
- 是否能改进事件处置?
- 如何加强预防?
- 如何加强检测?

## 入侵排查思路

### linux

#### 1.账号安全

基本使用

```
查看用户信息文件

[root@localhost ~]# cat /etc/passwd
root:x:0:0:root:/root:/bin/bash
用户名：密码：用户ID：组ID：用户说明：家目录：登录之后的shell

注意！！！无密码只允许本机登录，远程不允许无密码登录！！！

```



```
查看影子文件

[root@localhost ~]# cat /etc/shadow
root:$6$RDEPWkSpuRLSa1Wl$nh4zteT8YjxR4R62mjF.DnQqN/vHkGFbNAJ5XQ.Ce18HcTsnlMXE5GnxSuT9407lZz8VOEODul3HlGiq665uo.::0:99999:7:::
用户名：加密过后的密码：密码最后一次修改日期：两次密码修改的时间间隔：密码有效期：密码修改到期的警告天数：密码过期之后的宽限天数：账号失效时间：保留

```



```
查看当前登录用户

[root@localhost ~]# who
root     pts/0        2022-02-13 11:19 (192.168.136.1)
     （tty为本地登录、pts为远程登录）

"字段解释": {
"用户名": "当前登录的用户名。",
"终端类型": "用户登录的终端类型，其中':0'表示本地登录(GUI会话界面)，'pts/0'、'pts/1'等表示虚拟终端，IP地址表示通过网络登录。",
"登录时间": "用户登录系统的时间。",
"登录来源": "用户从何处登录系统，':0'表示本地登录，IP地址表示通过网络从该IP地址登录。"
```



```
查看系统信息，想得知某一时刻用户的行为

[root@localhost ~]# w
 21:12:52 up  3:33,  2 users,  load average: 0.00, 0.01, 0.05
USER     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT
root     pts/0    192.168.136.1    11:19    9:42m  0.05s  0.05s -bash
root     pts/1    192.168.136.1    21:05    5.00s  0.11s  0.03s w

"字段解释": {
"USER": "当前登录的用户名。",
"TTY": "用户登录的终端类型，其中':0'表示本地登录，'pts/0'、'pts/1'等表示虚拟终端，IP地址表示通过网络登录。",
"FROM": "用户从何处登录系统，':0'表示本地登录，IP地址表示通过网络从该IP地址登录。",
"LOGIN@": "用户登录系统的时间。",
"IDLE": "用户空闲的时间。",
"JCPU": "用户进程在系统中运行的总时间。",
"PCPU": "用户进程在系统中运行的当前时间。",
"WHAT": "用户当前正在运行的进程。"
}
```

入侵排查

ps -ef		#pid

```
cd /proc		#pid的信息文件
cd 要查看的pid
ll exe		#查看指向哪里
```

 lsof -p pid号		#查看pid号的调用的进程情况

 ps -aux：显示所有包含其他使用者的进程	

```
查看字段        cat /etc/passwd | awk -F '{print $1,$NF}'
```



```
查看用户和权限

1.查看特权用户（uid=0）
[root@localhost ~]# awk -F: '$3==0{print $1}' /etc/passwd
root
2.查询可以远程登陆的账号信息
[root@localhost ~]# awk '/\$1|\$6/{print $1}' /etc/shadow
root:$6$RDEPWkSpuRLSa1Wl$nh4zteT8YjxR4R62mjF.DnQqN/vHkGFbNAJ5XQ.Ce18HcTsnlMXE5GnxSuT9407lZz8VOEODul3HlGiq665uo.::0:99999:7:::
wmy:$6$Is4O04QcCRH/0Myr$eaVCiGeygY5pPH13FDWznH3WOgme5OfbWMsMApMbtQNaiGIDZmhi6mugW4DFoZB1Ebor3eoPCv.QJP0cUBR3G/::0:99999:7:::
3.查看其他账号是否有sudo权限
（除root账号外，非管理需要，普通账号应删除sudo权限）
[root@localhost ~]# more /etc/sudoers | grep -v "^#\|^$" | grep "ALL=(ALL)"
root	ALL=(ALL) 	ALL
%wheel	ALL=(ALL)	ALL
4.禁用或者删除多余的和可疑的账号（先禁用 再删除）  

4.1 禁用账号，账号无法登录（查看影子文件会增加！）
[root@localhost ~]# usermod -L www
[root@localhost ~]# cat /etc/shadow
www:!$6$G1dQFaz8$5dMxNYclGyPkzb7XOLKE1t52zhOi7k6/L6SwocJNq1b1EEWQVeAkZhhJkT5gpY12DMkIVAskIAxtoTtXUS4ZG/:19036:0:99999:7:::
4.2 解除禁用账户命令
[root@localhost ~]# usermod -U www
[root@localhost ~]# cat /etc/shadow
www:$6$G1dQFaz8$5dMxNYclGyPkzb7XOLKE1t52zhOi7k6/L6SwocJNq1b1EEWQVeAkZhhJkT5gpY12DMkIVAskIAxtoTtXUS4ZG/:19036:0:99999:7:::
4.3 删除用户 
[root@localhost ~]# cd /home
[root@localhost home]# ls
wmy  www
[root@localhost home]# userdel www
[root@localhost home]# ls -l
总用量 0
drwx------. 2 wmy  wmy  62 1月  30 14:26 wmy
drwx------. 2 1001 1001 62 2月  13 21:38 www
4.4 删除用户，并将/home目录下的user目录一并删除
[root@localhost ~]# userdel -r www
[root@localhost ~]# cd /home
[root@localhost home]# ls
wmy
```

#### 2.历史命令

基本使用：通过 .bash_history 文件查看账号执行过的系统命令

```
1.root账户查看历史命令
[root@localhost ~]# history 
2.打开 /home 各帐号目录下的 .bash_history，查看普通帐号执行的历史命令。
为历史的命令增加登录的 IP 地址、执行命令时间等信息：
a.保存1万条命令
sed -i 's/^HISTSIZE=1000/HISTSIZE=10000/g' /etc/profile
b.在/etc/profile的文件尾部添加如下行数配置信息：
######jiagu history xianshi#########
USER_IP=`who -u am i 2>/dev/null | awk '{print $NF}' | sed -e 's/[()]//g'`
if [ "$USER_IP" = "" ]
then
USER_IP=`hostname`
fi
export HISTTIMEFORMAT="%F %T $USER_IP `whoami` "
shopt -s histappend
export PROMPT_COMMAND="history -a"
######### jiagu history xianshi ##########

或者
命令历史显示时间，终端用户，来源等相关信息：
vim /root/.bashrc
export HISTTIMEFORMAT="%Y-%m-%d %H:%M:%S  `who am i | awk '{print $1,$5}'` "
source .bashrc

c.source /etc/profile 让配置生效
生成效果： 
[root@localhost home]# history
    1  2022-02-14 08:42:31 192.168.136.1 root mount /dev/sr0 /mnt
3.历史操作命令的清除：history -c
但此命令并不会清除保存在文件中的记录，因此需要手动删除 .bash_profile 文件中的记录。

```

入侵排查

```
cat .bash_history >> history.txt
进入用户目录，导出历史命令
```

#### 3.检查异常端口

使用netstat网络连接命令，进行分析

```
查找可疑的端口
netstat -antlp | grep ESTAB
netstat -antlp | more（主要还是对EXTABLISHED状态的进程进行查看）

[root@localhost ~]# netstat -antlp | grep ESTAB
tcp        0     36 192.168.136.132:22      192.168.136.1:56273     ESTABLISHED 1345/sshd: root@pts 
[root@localhost ~]# netstat -antlp | more
Active Internet connections (servers and established)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name 
   
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      1082/sshd        
   
tcp        0      0 127.0.0.1:25            0.0.0.0:*               LISTEN      1248/master      
   
tcp        0      0 0.0.0.0:111             0.0.0.0:*               LISTEN      658/rpcbind      
   
tcp        0     36 192.168.136.132:22      192.168.136.1:56273     ESTABLISHED 1345/sshd: root@p
ts 
tcp6       0      0 :::22                   :::*                    LISTEN      1082/sshd        
   
tcp6       0      0 ::1:25                  :::*                    LISTEN      1248/master      
   
tcp6       0      0 :::111                  :::*                    LISTEN      658/rpcbind      

```



```
查看pid所对应的进程文件或者路径
ls -l /proc/$PID/exe或者file（$PID为对应的pid号）

[root@localhost ~]# ls -l /proc/1345/exe
lrwxrwxrwx. 1 root root 0 2月  14 08:42 /proc/1345/exe -> /usr/sbin/sshd

```

#### 4.检查异常进程

```
使用ps命令分析对应pid的进程

ps -ef | grep pid
ps aux | grep pid

```

#### 5.检查开机启动项

系统运行级别示意图：

| 运行级别 | 含义                                                      |
| -------- | --------------------------------------------------------- |
| 0        | 关机                                                      |
| 1        | 单用户模式，可以想象为windows的安全模式，主要用于系统修复 |
| 2        | 不完全的命令行模式，不含NFS服务                           |
| 3        | 完全的命令行模式，就是标准字符界面                        |
| 4        | 系统保留                                                  |
| 5        | 图形模式                                                  |
| 6        | 重启动（init 6与reboot poweroff相似）                     |



```
查看运行级别（默认为3）
[root@localhost ~]# runlevel 
N 3

系统默认允许级别
vi  /etc/inittab  默认为3
id=3：initdefault  #系统开机后直接进入哪个运行级别

开机启动配置文件
/etc/rc.local
/etc/rc.d/rc[0~6].d

```

例子：当我们需要开机启动自己的脚本时，只需要将可执行脚本丢在 **/etc/init.d** 目录下，然后在 /etc/rc.d/rc*.d 文件中建立软链接即可。（此中的 * 代表 0,1,2,3,4,5,6 这七个等级）



```
[root@localhost ~]# ln -s /etc/init.d/sshd /etc/rc.d/rc3.d/S100ssh

此处sshd是具体服务的脚本文件，S100ssh是其软链接，S开头代表加载时自启动；如果是K开头的脚本文件，代表运行级别加载时需要关闭的。

```



```
入侵排查

启动项文件
more /etc/rc.local
/etc/rc.d/rc[0~6].d
ls -l /etc/rc.d/rc3.d/

```



#### 6.检查定时任务

1.使用crontab创建计划任务

```
列出某个用户cron服务的详细内容
[root@localhost ~]# crontab -l
默认编写的crontab文件会存放在  /var/spool/cron/用户名

删除每个用户的crontab任务（谨慎删除！！！）
[root@localhost ~]# crontab -r

使用编辑器编辑当前的crontab文件
[root@localhost ~]# crontab -e

```

2.使用anacron实现异步定时任务调度

```
每天运行 /home/backup.sh 脚本：
vi /etc/anacrontab 
@daily    10    example.daily   /bin/bash /home/backup.sh
当机器在 backup.sh 期望被运行时是关机的，anacron会在机器开机十分钟之后运行它，而不用再等待 7天。

```



```
入侵排查（重点！！!）

重点关注以下目录中是否存在恶意脚本
/var/spool/cron/* 
/etc/crontab
/etc/cron.d/*
/etc/cron.daily/* 
/etc/cron.hourly/* 
/etc/cron.monthly/*
/etc/cron.weekly/
/etc/anacrontab
/var/spool/anacron/*
小技巧：
more/etc/cron.daily/*查看目录下所有文件
```

![50b96ef42af1767ca67ee3aeacb0d60](C:\Users\16159\AppData\Roaming\Typora\typora-user-images\50b96ef42af1767ca67ee3aeacb0d60.png)



#### 7.检查服务

```
第一种
chkconfig --list

chkconfig [--level 运行级别] [独立服务名] [on|off]
chkconfig --level  2345 httpd on  开启自启动
chkconfig httpd on （默认level是2345）

第二种
修改 /etc/re.d/rc.local 文件  
加入 /etc/init.d/httpd start

第三种
使用 ntsysv 命令管理自启动，可以管理独立服务和 xinetd 服务

```

入侵排查

查询已经安装的服务

```
RPM包安装的服务

chkconfig  --list  查看服务自启动状态，可以看到所有的RPM包安装的服务
ps aux | grep crond 查看当前服务

系统在3与5级别下的启动项 
中文环境
chkconfig --list | grep "3:启用\|5:启用"
英文环境
chkconfig --list | grep "3:on\|5:on"


源码包安装的服务

查看服务安装位置 ，一般是在/user/local/
service httpd start
搜索/etc/rc.d/init.d/  查看是否存在

```

#### 8.检查异常文件

1.查看敏感目录，如/tmp目录下的文件，同时注意隐藏文件夹，以“…”为名的文件夹具有隐藏属性

2.得到发现WEBSHELL、远控木马的创建时间，如何找出同一时间范围内创建的文件？

 可以使用find命令来查找，如 find /opt -iname “*” -atime 1 -type f 找出 /opt 下一天前访问过的文件

3.针对可疑文件可以使用 stat 进行创建修改时间。

4.`find ./* -mmin 5`       #查看5分钟内改动过的文件

#### 9.检查系统日志

日志默认存放位置：/var/log/

查看日志配置情况：more /etc/rsyslog.conf

```
/var/spool/cron/*
/etc/crontab
/etc/cron.d/*
/etc/cron.daily/*
/etc/cron.hourly/*
/etc/cron.monthly/*
/etc/cron.weekly/
/etc/anacrontab
/var/spool/anacron/*
小技巧：
more/etc/cron.daily/*查看目录下所有文件
```

![f28cd01059e053ddfbbe18ce8054c66](C:\Users\16159\AppData\Roaming\Typora\typora-user-images\f28cd01059e053ddfbbe18ce8054c66.png)

![d4913055f1ccb3a0cb8cdccb57396b7](C:\Users\16159\AppData\Roaming\Typora\typora-user-images\d4913055f1ccb3a0cb8cdccb57396b7.png)

```
日志分析技巧：
1、定位有多少IP在爆破主机的root帐号：    
grep "Failed password for root" /var/log/secure | awk '{print $11}' | sort | uniq -c | sort -nr | more

cat /var/log/secure | awk '/Failed password/{print $11}' | sort -nr | uniq -c
定位有哪些IP在爆破：
grep "Failed password" /var/log/secure|grep -E -o "(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)"|uniq -c

爆破用户名字典是什么？
grep "Failed password" /var/log/secure|perl -e 'while($_=<>){ /for(.*?) from/; print "$1\n";}'|uniq -c|sort -nr

2、登录成功的IP有哪些： 	
grep "Accepted " /var/log/secure | awk '{print $11}' | sort | uniq -c | sort -nr | more

登录成功的日期、用户名、IP：
grep "Accepted " /var/log/secure | awk '{print $1,$2,$3,$9,$11}' 

3、增加一个用户kali日志：
Jul 10 00:12:15 localhost useradd[2382]: new group: name=kali, GID=1001
Jul 10 00:12:15 localhost useradd[2382]: new user: name=kali, UID=1001, GID=1001, home=/home/kali
, shell=/bin/bash
Jul 10 00:12:58 localhost passwd: pam_unix(passwd:chauthtok): password changed for kali
#grep "useradd" /var/log/secure 

4、删除用户kali日志：
Jul 10 00:14:17 localhost userdel[2393]: delete user 'kali'
Jul 10 00:14:17 localhost userdel[2393]: removed group 'kali' owned by 'kali'
Jul 10 00:14:17 localhost userdel[2393]: removed shadow group 'kali' owned by 'kali'

# grep "userdel" /var/log/secure

5、su切换用户：
Jul 10 00:38:13 localhost su: pam_unix(su-l:session): session opened for user good by root(uid=0)

sudo授权执行:
sudo -l（只能出现root）
Jul 10 00:43:09 localhost sudo:    good : TTY=pts/4 ; PWD=/home/good ; USER=root ; COMMAND=/sbin/shutdown -r now

```

#### 10.查杀工具

河马

D盾





```bash
grep "Failed password for root" /var/log/secure | awk '{print $11}' | sort | uniq -c | sort -nr | more			#定位有多少IP在爆破主机的root帐号

定位有哪些IP在爆破：
grep "Failed password" /var/log/secure|grep -E -o "(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?).(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?).(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?).(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)"|uniq -c | sort -nr

爆破用户名字典是什么？
grep "Failed password" /var/log/secure|perl -e 'while($_=<>){ /for(.*?) from/; print "$1\n";}'|uniq -c|sort -nr

登录成功的IP有哪些：	
grep "Accepted " /var/log/secure | awk '{print $11}' | sort | uniq -c | sort -nr | more

登录成功的日期、用户名、IP
grep "Accepted " /var/log/secure | awk '{print $1,$2,$3,$9,$11}'
```

沙箱（文件分析）：

```
沙箱（文件分析）

VirScan
https://www.virscan.org/

微步在线云沙箱
https://s.threatbook.com/

奇安信情报沙箱
https://sandbox.ti.qianxin.com/sandbox/page

360沙箱云
https://ata.360.net/
```

威胁情报：

```
威胁情报

安恒威胁情报中心
https://ti.dbappsecurity.com.cn/

Pulsedive威胁情报中心
https://pulsedive.com/dashboard/

绿盟威胁分析中心
https://poma.nsfocus.com/

360威胁情报中心
https://ti.360.net

奇安信威胁情报中心
https://ti.qianxin.com

微步在线威胁情报社区
https://x.threatbook.com
```

webshell查杀

```
https://www.shellpub.com/		#河马

https://www.d99net.net/			#D盾

功能特性简介
一句话免疫,主动后门拦截,SESSION保护,防WEB嗅探,防CC,防篡改,注入防御,防XSS,防提权,上传防御,未知0day防御,异 形脚本防御等等。 防止黑客入侵和提权,让服务器更安全。
[目录限制]
有效防止入侵者通过脚本上传危险程序或代码,让服务运行于安全状态。
[执行限制]
防范入侵者执行危险程序，防范提权的发生。
[网络限制]
禁止脚本连接本机的危险端口，如常见的Serv-U提权端口，防范通过第三方软件的网络端口进行提 权禁止UDP向外发送，可有效防范UDP的DDOS攻击，如PHPDDOS等，有效限制网络带宽给恶意占用
[组件限制]
禁止危险的组件,让服务器更安全。
[.net安全]
去除 .net 一些危险基因，让服务器更安全!
[注入防御]
防范因网站有注入问题导致服务器给入侵
3389防御]
防范黑客未经许可登陆你的3389，让服务器更安全!
[防CC攻击!]
让网站免受CC攻击困扰!
[禁止下载某文件类型]
防止不该给下载的文件给下载,防止信息外露!
[允许执行的脚本扩展名]
有效的防止未经允许的扩展名脚本恶意执行,如: CER,CDX 等扩展名的木马。或是 /1.asp/1.gif 等会执行的情况
[禁止如下目录执行脚本]
防止图片和上传等可写目录执行脚本
[防范工具扫描网站目录和文件信息]
让入侵者不容易知道你的网站结构
[防范MSSQL数据库错误信息反馈暴露表或数据信息]
防范信息暴露。
```

### windows

#### 用户安全

查看服务器是否存在弱口令

查看远控端口是否对外开放

`lusrmgr .msc`		#查看可疑用户，新增用户



检查隐藏用户和克隆用户

`net user test$ 123.com /add`		#创建隐藏用户

![9e2168798f3411aef5b32739ad7a64b](C:\Users\16159\AppData\Roaming\Typora\typora-user-images\9e2168798f3411aef5b32739ad7a64b.png)

![040ebcc5311adf3f13f074c98a7f4af](C:\Users\16159\AppData\Roaming\Typora\typora-user-images\040ebcc5311adf3f13f074c98a7f4af.png)

用D盾可以查到隐藏用户和克隆用户



#### windows日志

eventvwr.msc		#事件查看器

#### 端口

netstat -ano			#查看端口占用

#### 进程

tasklist					#显示运行计算机上的所有进程

tasklist | findstr "PID"		#过滤

#### 计划任务

schtasks.exe		#cmd命令

控制面板->计划任务

#### 检查服务

1.任务管理器

2.msconfig

![image-20230918143250098](C:\Users\16159\AppData\Roaming\Typora\typora-user-images\image-20230918143250098.png)

3.services.msc			#服务

![image-20230918143658584](C:\Users\16159\AppData\Roaming\Typora\typora-user-images\image-20230918143658584.png)

#### 检查系统信息

systeminfo

#### 检查异常文件

在win+R中输入%UserProfile%\Recent		#查看最近打开的文件

#### 流量分析

wireshark

- Frame:物理层的数据桢概况
- Ethernetll: 数据链路层以太网帧头部信息
- Internet Protocol Version 4:互联网层IP包头部信息
- Transmission Control Protocol:传输层的数据段头部信息，此处是TCP协议
- Hypertext Transfer Protocol:应用层的信息，此处是HTTP协议。

分析流量

- 筛选出http流量后发现info信息
- info信息显示GET和POST，以及upload内容
- 通过以上内容可以判断

追踪流

查找内容

#### 日志分析

- windows系统日志是记录系统中硬件、软件和系统问题的信息，同时还可以监视系统中发生的事件。
- 用户可以通过它来检查错误发生的原因，或者寻找受到攻击时攻击者留下来的痕迹
- Windows主要有以下三类日志记录系统时间：
  - 应用程序日志
  - 系统日志
  - 安全日志

##### 应用程序日志

- 包含有应用程序或系统程序记录的事件，主要记录程序运行方面的事件，例如数据库程序可以在应用程序日志中记录文件错误，程序开发人员可以自行决定监视哪些事件
- 如果某个应用程序出现崩溃情况，那么我们可以从程序事件日志中找到相应的记录，也许会有助于你解决问题
- 默认位置：%SystemRoot%\System32\Winevt\Logs\Application.evtx

##### 系统日志

1.windows操作系统组件产生的事件，主要包括驱动程序、系统组件和应用软件的崩溃以及数据丢失错误等。
2.默认位置：C:\windows\system32\winevt\logs\system.evtx

##### 安全日志

- 主要记录系统的安全信息，包括成功的登录、退出，不成功的登录，系统文件的创建、删除、更改，需要指明的是安全日志只有系统管理员才可以访问，这也体现了在大型系统中安全的重要性。
- 默认位置:C:Windows\System32\winevt\Logs\Security.evtx

##### 温馨提示

- 系统和应用程序日志存储着故障排除信息，对于系统管理员更为有用。
- 安全日志记录着事件审计信息，包括用户验证(登录、远程访问等)和特定用户在认证后对系统做了什么，对于调查人员而言更有帮助

##### 审核策略与事件查看器

- Windows Server 2008 R2系统的审核功能在默认状态下并没有启用 ，建议开启审核策略。
- 若日后系统出现故障、安全事故则可以查看系统的日志文件，排除故障，追查入侵者的信息等。
- 注:默认状态下，也会记录一些简单的日志，日志默认大小20M

##### 审核策略

- 控制面板->管理工具->本地安全策略->本地策略->审核策略
- 参考配置如下

##### 事件查看器

- 开始->运行->eventvwr.msc
- win+x，打开事件查看器
- 设置合理的日志属性，即日志最大大小、事件覆盖阈值等

##### 事件日志分析

- Windows事件日志文件本质上是数据库，其中包括有关系统、安全、应用程序的记录
- 记录的时间包含9个元素：
  - 日期/时间、事件类型
  - 用户、计算机
  - 事件id、来源
  - 类别、描述
  - 数据等信息
- Windows事件日志总共有五种事件类型，所有的事件必须只能拥有其中一种事件类型

- 信息(information)
  -  信息事件指应用程序、驱动程序或服务的成功操作的事件

- 警告(Warning)

  - 警告事件指不是直接的、主要的，但是会导致将来问题发生的问题》

  - 例如，当磁盘空间不足或未找到打印机时，都会记录一个警告事件

- 成功审核(Success qudit)
  - 成功的审核安全访问尝试，主要是指安全性日志，这里记录着用户登录/注销、账号登录、账户管理、策略更改等事件，成功登录系统会被记录为“成功审核”
- 失败审核(Faliure audit)
  - 失败的审核安全登录尝试，例如用户试图访问网络驱动器失败，则该尝试会被作为失败审核事件记录下来

##### 常见事件id

- 对于Windows事件日志分析，不同的EVENTID（事件标识符）代表了不同的意义，摘录一些常见的安全事件的说明：

| 事件id | 说明                         |
| ------ | ---------------------------- |
| 4624   | 账户已成功登录（登陆成功）   |
| 4625   | 账户无法登录（登陆失败）     |
| 4634   | 账户已注销（注销成功）       |
| 4647   | 用户启动了注销               |
| 4672   | 使用超级用户（如管理员）登录 |
| 4720   | 已创建用户账户               |



```
1、查询登录成功的事件
登录成功的所有事件
LogParser.exe -i:EVT –o:DATAGRID  "SELECT *  FROM c:\Security.evtx where EventID=4624"

指定登录时间范围的事件：
LogParser.exe -i:EVT –o:DATAGRID  "SELECT *  FROM c:\Security.evtx where TimeGenerated>'2018-06-19 23:32:11' and TimeGenerated<'2018-06-20 23:34:00' and EventID=4624"

提取登录成功的用户名和IP：
LogParser.exe -i:EVT  –o:DATAGRID  "SELECT EXTRACT_TOKEN(Message,13,' ') as EventType,TimeGenerated as LoginTime,EXTRACT_TOKEN(Strings,5,'|') as Username,EXTRACT_TOKEN(Message,38,' ') as Loginip FROM c:\Security.evtx where EventID=4624"
2、查询登录失败的事件
登录失败的所有事件：
LogParser.exe -i:EVT –o:DATAGRID  "SELECT *  FROM c:\Security.evtx where EventID=4625"

提取登录失败用户名进行聚合统计：
LogParser.exe  -i:EVT "SELECT  EXTRACT_TOKEN(Message,13,' ')  as EventType,EXTRACT_TOKEN(Message,19,' ') as user,count(EXTRACT_TOKEN(Message,19,' ')) as Times,EXTRACT_TOKEN(Message,39,' ') as Loginip FROM c:\Security.evtx where EventID=4625 GROUP BY Message"
3、系统历史开关机记录：
LogParser.exe -i:EVT –o:DATAGRID  "SELECT TimeGenerated,EventID,Message FROM c:\System.evtx where EventID=6005 or EventID=6006"
```

### LAMP

APACHE

```
/var/log/httpd/access_log		#apache访问日志

/var/lib/mysql/bogon.log		#数据库日志

web日志分析小技巧:
#显示访问web程序频率最高的IP
cut -d- -f 1 /var/log/httpd/access_log|uniq -c | sort -rn | head -20	

查看某个页面被访问的次数
grep "/sqli" /var/log/httpd/access_log | wc -l

将每个IP访问的页面数量显示出来
awk '{++S[$1]} END {for (a in S) print a,S[a]}' /var/log/httpd/access_log

查看192.168.20.1这个IP地址访问了那些页面
grep ^192.168.20.1 /var/log/httpd/access_log| awk '{print $1,$7}'

查看2023年9月20日11时这一个小时内有多少IP访问
awk '{print $4,$1}' /var/log/httpd/access_log | grep 20/Sep/2023:11 | awk '{print $2}'| sort | uniq | wc -l
```



```
数据库日志分析小技巧

查看有那些IP暴力破解我的数据库
grep  "Access denied" /var/lib/mysql/bogon.log |cut -d "'" -f4|uniq -c|sort -nr

显示暴力破解用户名的字典都有哪些
grep  "Access denied" /var/lib/mysql/bogon.log |cut -d "'" -f2|uniq -c|sort -nr
```

